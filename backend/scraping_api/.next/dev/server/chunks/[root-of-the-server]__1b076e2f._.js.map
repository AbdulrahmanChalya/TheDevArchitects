{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/jessebui/Documents/Code/Capstone/TheDevArchitects/backend/scraping_api/lib/expediaFlights.ts"],"sourcesContent":["type BuildFlightUrlParams = {\n  originAirport: string;\n  destinationAirport: string;\n  departureDate: string;\n  returnDate: string;\n  adults: number;\n};\n\nfunction formatDateForExpedia(date: string) {\n  const d = new Date(date);\n  const day = String(d.getUTCDate()).padStart(2, \"0\");\n  const month = String(d.getUTCMonth() + 1).padStart(2, \"0\");\n  const year = d.getUTCFullYear();\n  return `${day}/${month}/${year}`;\n}\n\nexport function buildExpediaFlightSearchUrl({\n  originAirport,\n  destinationAirport,\n  departureDate,\n  returnDate,\n  adults,\n}: BuildFlightUrlParams) {\n  const base = \"https://www.expedia.ca/Flights-Search\";\n\n  const dep = formatDateForExpedia(departureDate);\n  const ret = formatDateForExpedia(returnDate);\n\n  const leg1 = `leg1=from:${encodeURIComponent(\n    originAirport\n  )},to:${encodeURIComponent(\n    destinationAirport\n  )},departure:${encodeURIComponent(`${dep}TANYT`)}`;\n\n  const leg2 = `leg2=from:${encodeURIComponent(\n    destinationAirport\n  )},to:${encodeURIComponent(originAirport)},departure:${encodeURIComponent(\n    `${ret}TANYT`\n  )}`;\n\n  const passengers = `passengers=${encodeURIComponent(\n    `children:0,adults:${adults},seniors:0,infantinlap:Y`\n  )}`;\n\n  const options = `options=${encodeURIComponent(\"cabinclass:economy\")}`;\n\n  const qs = [\n    \"trip=roundtrip\",\n    leg1,\n    leg2,\n    passengers,\n    options,\n    \"mode=search\",\n  ].join(\"&\");\n\n  return `${base}?${qs}`;\n}\n"],"names":[],"mappings":";;;;AAQA,SAAS,qBAAqB,IAAY;IACxC,MAAM,IAAI,IAAI,KAAK;IACnB,MAAM,MAAM,OAAO,EAAE,UAAU,IAAI,QAAQ,CAAC,GAAG;IAC/C,MAAM,QAAQ,OAAO,EAAE,WAAW,KAAK,GAAG,QAAQ,CAAC,GAAG;IACtD,MAAM,OAAO,EAAE,cAAc;IAC7B,OAAO,GAAG,IAAI,CAAC,EAAE,MAAM,CAAC,EAAE,MAAM;AAClC;AAEO,SAAS,4BAA4B,EAC1C,aAAa,EACb,kBAAkB,EAClB,aAAa,EACb,UAAU,EACV,MAAM,EACe;IACrB,MAAM,OAAO;IAEb,MAAM,MAAM,qBAAqB;IACjC,MAAM,MAAM,qBAAqB;IAEjC,MAAM,OAAO,CAAC,UAAU,EAAE,mBACxB,eACA,IAAI,EAAE,mBACN,oBACA,WAAW,EAAE,mBAAmB,GAAG,IAAI,KAAK,CAAC,GAAG;IAElD,MAAM,OAAO,CAAC,UAAU,EAAE,mBACxB,oBACA,IAAI,EAAE,mBAAmB,eAAe,WAAW,EAAE,mBACrD,GAAG,IAAI,KAAK,CAAC,GACZ;IAEH,MAAM,aAAa,CAAC,WAAW,EAAE,mBAC/B,CAAC,kBAAkB,EAAE,OAAO,wBAAwB,CAAC,GACpD;IAEH,MAAM,UAAU,CAAC,QAAQ,EAAE,mBAAmB,uBAAuB;IAErE,MAAM,KAAK;QACT;QACA;QACA;QACA;QACA;QACA;KACD,CAAC,IAAI,CAAC;IAEP,OAAO,GAAG,KAAK,CAAC,EAAE,IAAI;AACxB","debugId":null}},
    {"offset": {"line": 78, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/parsing/expediaFlightCustomParser.json"],"sourcesContent":["{\"flights\":{\"_fns\":[{\"_fn\":\"xpath\",\"_args\":[\"//*[@data-test-id='listings']//*[@data-test-id='offer-listing']\"]}],\"_items\":{\"airline\":{\"_fns\":[{\"_fn\":\"xpath_one\",\"_args\":[\"(.//*[@data-stid='flight-information-section']//div[contains(@class,'uitk-text') and contains(@class,'uitk-text-secondary-theme')])[2]/text()\"]}]},\"airlineLogo\":{\"_fns\":[{\"_fn\":\"xpath_one\",\"_args\":[\".//img[contains(@class,'uitk-mark-landscape-oriented')]/@src\",\"(.//*[@data-stid='flight-information-section']/ancestor::div[contains(@class,'uitk-layout-grid')][1]//img[contains(@class,'uitk-mark-landscape-oriented')])[1]/@src\"]}]},\"route\":{\"_fns\":[{\"_fn\":\"xpath_one\",\"_args\":[\"(.//*[@data-stid='flight-information-section']//div[contains(@class,'uitk-text') and contains(@class,'uitk-text-secondary-theme')])[1]/text()\"]}]},\"price\":{\"_fns\":[{\"_fn\":\"xpath_one\",\"_args\":[\".//div[@data-stid='price-display']//span[@aria-hidden='true']/text()\"]},{\"_fn\":\"amount_from_string\"}]},\"duration\":{\"_fns\":[{\"_fn\":\"xpath_one\",\"_args\":[\".//div[@data-stid='tertiary-section']//span[contains(@class,'uitk-type-300')][1]/text()\"]}]}}}}"],"names":[],"mappings":"AAAA"}},
    {"offset": {"line": 78, "column": 1114}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/jessebui/Documents/Code/Capstone/TheDevArchitects/backend/scraping_api/lib/flightParsers.ts"],"sourcesContent":["export const parseRouteFull = (route: string) => {\n  const match = route.match(/^(.*?)\\s*-\\s*(.*)$/);\n\n  return {\n    departureAirport: match?.[1]?.trim() || null, // \"New York (JFK)\"\n    arrivalAirport: match?.[2]?.trim() || null, // \"Paris (CDG)\"\n  };\n};\n"],"names":[],"mappings":";;;;AAAO,MAAM,iBAAiB,CAAC;IAC7B,MAAM,QAAQ,MAAM,KAAK,CAAC;IAE1B,OAAO;QACL,kBAAkB,OAAO,CAAC,EAAE,EAAE,UAAU;QACxC,gBAAgB,OAAO,CAAC,EAAE,EAAE,UAAU;IACxC;AACF","debugId":null}},
    {"offset": {"line": 97, "column": 0}, "map": {"version":3,"sources":["file:///Users/jessebui/Documents/Code/Capstone/TheDevArchitects/backend/scraping_api/app/api/flights/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { buildExpediaFlightSearchUrl } from \"../../../lib/expediaFlights\";\nimport expediaFlightParser from \"../../../parsing/expediaFlightCustomParser.json\";\nimport type { FlightSummary } from \"../../../types/flight\";\nimport { parseRouteFull } from \"../../../lib/flightParsers\";\n\n// Optional: cache this route for 1 hour on the Next.js side\nexport const revalidate = 60 * 60;\n\n// Helper to split \"New York (JFK) - Paris (CDG)\" -> JFK / CDG\n// const parseRoute = (route?: string) => {\n//   if (!route) {\n//     return { departureAirport: null, arrivalAirport: null };\n//   }\n\n//   const match = route.match(/\\((.*?)\\)\\s*-\\s*\\((.*?)\\)/);\n//   return {\n//     departureAirport: match?.[1] || null,\n//     arrivalAirport: match?.[2] || null,\n//   };\n// };\n\nexport async function GET(req: NextRequest) {\n  try {\n    const { searchParams } = new URL(req.url);\n\n    // Expect IATA codes here, e.g. origin=JFK&destination=CDG\n    const originAirport = searchParams.get(\"origin\") || \"\";\n    const destinationAirport = searchParams.get(\"destination\") || \"\";\n    const departureDate = searchParams.get(\"startDate\") || \"\"; // YYYY-MM-DD\n    const returnDate = searchParams.get(\"endDate\") || \"\"; // YYYY-MM-DD\n    const adults = Number(searchParams.get(\"people\") || 1);\n    const cabinClass = searchParams.get(\"class\") || \"Economy\";\n\n    if (\n      !originAirport ||\n      !destinationAirport ||\n      !departureDate ||\n      !returnDate\n    ) {\n      return NextResponse.json(\n        {\n          error:\n            \"Missing required query params. Required: origin, destination, startDate, endDate\",\n        },\n        { status: 400 }\n      );\n    }\n\n    const expediaSearchUrl = buildExpediaFlightSearchUrl({\n      originAirport,\n      destinationAirport,\n      departureDate,\n      returnDate,\n      adults,\n    });\n\n    const username = process.env.OXYLABS_USERNAME;\n    const password = process.env.OXYLABS_PASSWORD;\n\n    if (!username || !password) {\n      return NextResponse.json(\n        {\n          error:\n            \"Missing OXYLABS_USERNAME or OXYLABS_PASSWORD environment variables\",\n        },\n        { status: 500 }\n      );\n    }\n\n    const authToken = Buffer.from(`${username}:${password}`).toString(\"base64\");\n\n    const payload = {\n      source: \"universal\",\n      url: expediaSearchUrl,\n      render: \"html\",\n      parse: true,\n      parsing_instructions: expediaFlightParser,\n      browser_instructions: [\n        {\n          type: \"scroll_to_bottom\",\n          timeout_s: 30,\n          wait_time_s: 20,\n        },\n      ],\n    };\n\n    const res = await fetch(\"https://realtime.oxylabs.io/v1/queries\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Authorization: `Basic ${authToken}`,\n      },\n      body: JSON.stringify(payload),\n      // You *can* also add: next: { revalidate: 60 * 60 } here if you want\n    });\n\n    if (!res.ok) {\n      const text = await res.text();\n      console.error(\"Oxylabs error:\", res.status, text);\n      return NextResponse.json(\n        {\n          error: \"Oxylabs error\",\n          status: res.status,\n          details: text.slice(0, 500),\n        },\n        { status: res.status }\n      );\n    }\n\n    const data = await res.json();\n\n    const content = data?.results?.[0]?.content;\n    const flightsRaw = (content?.flights || []) as any[];\n\n    const flights: FlightSummary[] = flightsRaw.map((f, index) => {\n      const { departureAirport, arrivalAirport } = parseRouteFull(f.route);\n\n      // f.price should already be numeric because of amount_from_string,\n      // but we normalise anyway just in case\n      let numericPrice = 0;\n      if (typeof f.price === \"number\") {\n        numericPrice = f.price;\n      } else if (typeof f.price === \"string\") {\n        const cleaned = f.price.replace(/[^\\d.]/g, \"\");\n        numericPrice = cleaned ? Number(cleaned) : 0;\n      }\n\n      return {\n        id: `flight-${index + 1}`,\n        airline: f.airline ?? null,\n        logo: f.airlineLogo || null,\n        departureAirport: departureAirport ?? null,\n        arrivalAirport: arrivalAirport ?? null,\n        price: numericPrice,\n        duration: f.duration ?? null,\n        class: cabinClass, // from query; list view usually doesn't show cabin class\n      };\n    });\n\n    return NextResponse.json({ flights, expediaSearchUrl });\n  } catch (err: any) {\n    console.error(\"Flights API error:\", err);\n    return NextResponse.json(\n      {\n        error: \"Server failed\",\n        detail: err?.message ?? String(err),\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}